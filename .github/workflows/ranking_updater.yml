# .github/workflows/ranking_updater.yml

name: Update Firestore Rankings

on:
  schedule:
    # 한국 시간(KST)으로 매일 00시 정각에 실행되도록 UTC 기준 15:00로 설정
    - cron: '0 15 * * *'
  
  # 수동 실행을 위한 옵션
  workflow_dispatch:

jobs:
  update-firestore-rankings:
    runs-on: ubuntu-latest

    steps:
      # 1. 저장소 코드를 기본 경로에 체크아웃합니다.
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Python 환경을 설정합니다.
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 3. Python 의존성 라이브러리를 설치합니다.
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install firebase-admin pytz

      # 4. (★★★ 가장 중요한 디버깅 스텝 ★★★)
      # 현재 작업 공간의 모든 파일과 디렉터리 구조를 출력하여 문제를 진단합니다.
      - name: "DEBUG: List all files and find the script"
        id: debug_step # 이 스텝에 ID를 부여합니다.
        run: |
          echo "Current workspace is: ${{ github.workspace }}"
          echo "=================================================="
          echo "Listing all files and directories recursively:"
          ls -R
          echo "=================================================="
          echo "Finding rank_updater.py file..."
          # 'find' 명령으로 rank_updater.py의 전체 경로를 찾습니다.
          SCRIPT_PATH=$(find ${{ github.workspace }} -name "rank_updater.py")
          if [[ -z "$SCRIPT_PATH" ]]; then
            echo "::error::rank_updater.py not found in the workspace!"
            exit 1
          fi
          echo "Script found at: $SCRIPT_PATH"
          # 찾은 경로를 GitHub Actions의 출력 변수로 설정합니다.
          echo "script_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT

      # 5. 위 디버깅 스텝에서 찾은 정확한 경로로 Python 스크립트를 실행합니다.
      - name: Run ranking update script
        env:
          FIREBASE_CREDENTIALS_JSON: ${{ secrets.FIREBASE_CREDENTIALS }}
        # 'needs'와 'steps' context를 사용하여 다른 스텝의 출력값을 가져옵니다.
        run: python ${{ steps.debug_step.outputs.script_path }}
